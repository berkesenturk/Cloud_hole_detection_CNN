name: Train Cloud Hole Detection Model

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_RESOURCE_GROUP:  ${{ secrets.AZURE_RESOURCE_GROUP }}
  AZURE_ML_WORKSPACE:    ${{ secrets.AZURE_ML_WORKSPACE }}

jobs:
  development:
    name: Train model
    
    runs-on: ubuntu-latest
    
    environment:
      name: "development"
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      # FIX 1: Install specific version of Azure ML extension
      - name: Install Azure ML extension
        run: |
          az extension remove -n ml || true
          az extension add -n ml --version 2.22.0 --yes
          az version

      # FIX 2: Set subscription before running job
      - name: Set Azure subscription
        run: |
          az account set --subscription "$AZURE_SUBSCRIPTION_ID"
          az account show

      # FIX 3: Run training job with correct parameters
      - name: Run training job
        run: |
          az ml job create \
            --file src/train_job.yml \
            --resource-group "$AZURE_RESOURCE_GROUP" \
            --workspace-name "$AZURE_ML_WORKSPACE" \
            --subscription "$AZURE_SUBSCRIPTION_ID"